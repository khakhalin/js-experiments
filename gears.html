<!DOCTYPE html>
<html> 
	<head> 
		<title>Dancing arrows illusion</title>
		<META name="author" content="Arseny Khakhalin">
		<META name="contact" content="khakhalin@bard.edu">
		<meta name="description" content="Gears">
		<script src="../p5/p5.js"></script>
		<script src="../p5/addons/p5.dom.js"></script>
		<script src="../p5/addons/p5.sound.js"></script>
	</head>
	<body>
	<div id="container" style="">
	<div id="left" style="width:200px; display:inline-block; *display: inline; vertical-align: top">
	<!-- if we want to have a menu on the left, but I doubt it in this case -->
	</div>
	<div id="viz" style="display:inline-block; *display: inline; vertical-align: top;">
	<script type="text/javascript">
	
	var my = {
		cMaxWidth:1400,		// Max canvas width
		nMax:1000,			// Max number of gears
		nCol:0,				// Number of columns; unknown for now
		nRow:0,				// same for rows
		size: 15,			// size of one gear
		tic:0,				// timestamp
        }
	
	var gears = [];
	
	function setup() {	  
		myCanvas = createCanvas(windowWidth-50,windowHeight-50);		// Slightly smaller than reported window
		myCanvas.parent('viz');
		my.tic = millis();
		
		for(k=0; k<my.nMax; k++) {										// Pre-create quite a few, just in case
			gears[k] = new gear();
		}
	}		
		
	function draw() {
		background(255);
		stroke(1);
		
		my.nCol = floor(windowWidth/my.size/2)-2;
		my.nRow = floor(windowHeight/my.size/2)-2;
		
		k = 0;
		for(i=0; i<my.nCol; i++) {
			for(j=0; j<my.nRow; j++) {
				if(k<my.nMax) {
					gears[k].i = i;		// Let it know its place
					gears[k].j = j;
					gears[k].x = (i+0.5)*2*my.size;
					gears[k].y = (j+0.5)*2*my.size;
					if((i===5)&&(j===5)){gears[k].v = 2;}
					if(j>0) {
						gears[k].check(i,j-1);	// Up
					}
					if(i>0){
						gears[k].check(i-1,j);	// Left
					}
					gears[k].draw();
				}
				k++;
			}
		}
	}
	
	function gear(){
		this.i = 0;
		this.j = 0;
		this.x = 0;
		this.y = 0;
		this.endX = 0;
		this.endY = 0;
		this.a = random(1)*PI;
		this.v = 0.1; //(random(1)-0.5)*3;
		this.l = my.size;
		this.tic = millis();
		
		this.check = function(i,j){
			other = gears[i*my.nRow + j];
			if(dist(this.endX,this.endY,other.endX,other.endY)<5){
				this.lightX = other.endX;
				this.lightY = other.endY;
				temp = this.v;		// Exchange angular speeds
				this.v = -other.v;
				other.v = -temp;
			}
		}
	
		this.draw = function() {
			push();
			stroke(1);
			this.a = this.a + this.v*(millis()-this.tic)/500;
			this.tic = millis();
			this.endX = this.x+cos(this.a)*this.l;
			this.endY = this.y+sin(this.a)*this.l;
			line(this.x,this.y,this.endX,this.endY);
			if(this.lightX>0) {
				push;
				stroke([255,0,0]);
				line(this.endX,this.endY,this.lightX,this.lightY)
			}
			this.lightX = 0;		// inactivate flare
			this.lightY = 0;
			pop();
		}
	}
	
    </script>       
    </div>
	</div>
	<div>Coded by <a href="https://sites.google.com/view/khakhalin/">Arseny Khakhalin</a>.</div>
	</body> 
</html> 